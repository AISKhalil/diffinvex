# DiffInvex: Computational framework for quantifying changes in somatic selection during cancer evolution and treatment. 

**DiffInvex (Differential Introns Versus Exons)** is an R-based statistical method to identify conditional selection on point mutations between two or more time points/conditions. 

**DiffInvex** first estimates the local baseline mutation rate (BMR) based on the intronic mutations in addition to UTRs and flanking intergenic mutations, controlling for the heterogeneous mutational landscape across the genome, without the need for inferring BMR from covariate information such as gene expression and replication time. Additionally, **DiffInvex** employs a locus sampling approach  to control for within-gene variation in mutation risk by matching the trinucleotide and pentanucleotide composition as well as the DNA methylation status between target (exonic) and background (intronic and intergenic) regions. 

Next, **DiffInvex** utilized a Poisson regression model, further regularized by a weakly-informative prior, to determine the differential excess of point mutations in target regions over the baseline regions between different condtions. This regression model can also control for confounding factors between conditions such as tumor types and for technical variation between data sourced from different cohorts.

**For a full description of the method and applications, please check [DiffInvex Manuscript](https://www.biorxiv.org/content/10.1101/2024.06.17.599362v1).**
  
## Contents
- [Download](#Download)
- [Installation](#installation)
- [Input Preparation](#input_preparation)
- [Parameters](#parameters)
- [Usage](#usage)
  
     
### <a name="Download"></a>Download
```bash
cd ~
git clone https://github.com/AISKhalil/diffinvex.git
```
   
     
### <a name="installation"></a>Installation
To run **DiffInvex**, it's recommended to set up an isolated conda environment to install the required packages:

1. If you don't have `conda` installed, download and install [Miniconda](https://docs.conda.io/en/latest/miniconda.html) or [Anaconda](https://www.anaconda.com/products/distribution).

2. Create `diffinvex_env` conda environment using the `diffinvex_env.yml` or `diffinvex_env_conda_install.sh` script:

```bash
conda env create -f diffinvex_env.yml
```

3. Activate the `diffinvex_env` conda environment:

```bash
conda activate diffinvex_env
```  

  
### <a name="input_preparation"></a>Input Preparation
**DiffInvex** requires 4 main files for quanifying selection and conditional selection during tumor progression.
Please check the provided files in `example` folder.

    mutation_file       - input .csv file with mutation data (single base substitutions and multi base substitutions) in the following format: 
                        	chrom,pos,ref,alt,Sample
                        	1,781002,G,A,PD1456
   
    annotation_file     - input .csv file with annotations per sample (one row per sample) in the following format:
                        	Sample,tumor_type,isTreated 
                        	PD1456,NSCLC,1
 
    variable_file       - input .txt file with DiffInvex regression explantory variables.
    			For a regression forumla #mutations ~ isTarget + isTreated + isTarget:isTreated + tumor_type, each row should contain one regression term as follows:
				isTarget
				isTreated
				isTarget:isTreated
				tumor_type    

    gene_file           - input .txt file with names of genes to be tested as follows:
				"KRAS"
				"TP53"
				"BRAF"  

  
### <a name="parameters"></a>Parameters
The main parameters of **DiffInvex**:

    reference_genome       - hg19 or hg38. 
                           The reference genome that is used for DiffInvex (default hg19). We are updating DiffInvex to support hg38.
   
    no_cores               - number of CPUs to be used (default 1). So, DiffInvex can be applied for many genes in parallel.
 
    output_directory       - path for saving output files generated by the diffinvex method. 
   
     
### <a name="usage"></a>Usage 
We provided `run_diffinvex.sh` bash script that could be used for testing the installation of **DiffInvex** using subsample of POG570 dataset in `example` folder.
Users can easily modify it to run **DiffInvex** on their own data.

1) add DiffInvex directory to the environment variable $PATH:
```
diffinvex_directory=../diffinvex
diffinvex_R="$diffinvex_directory"/R
export PATH="$PATH:$diffinvex_directory:$diffinvex_R"
```
2) define your input files:
```
data_dir="./example"
mutation_file="$data_dir"/pog570_SBSs.csv
annotation_file="$data_dir"/pog570_annotations.csv
variable_file="$data_dir"/pog570_variables.txt
gene_file="$data_dir"/cgc_tcga_genes.txt
```
3) set the output directory and DiffInvex parameters:
```
output_directory=./example/pog570_diffinvex_results
reference_genome=hg19
no_cores=4
```
4) run the DiffInvex framework:
```
bash diffinvex.sh $mutation_file $annotation_file $variable_file $gene_file $output_directory $diffinvex_directory $reference_genome $no_cores
```

Alternatively, user can use `run_diffinvex.R` Rscript for running **DiffInvex**.

## We are adding examples of using DiffInvex for different biological problems ...
